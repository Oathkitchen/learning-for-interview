<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹å¯è§†åŒ–</title>
    <style>
        :root {
            --client-color: #3498db;
            --server-color: #2ecc71;
            --packet-color: #e74c3c;
            --bg-color: #f4f6f7;
            --text-color: #2c3e50;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        h1 {
            margin-bottom: 20px;
        }
        .controls {
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #fff;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            transition: all 0.3s;
        }
        button:hover {
            background-color: #ecf0f1;
            border-color: #95a5a6;
        }
        button.active {
            background-color: var(--client-color);
            color: white;
            border-color: var(--client-color);
        }

        .diagram-container {
            display: flex;
            justify-content: space-between;
            width: 800px;
            height: 500px;
            position: relative;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 40px;
            box-sizing: border-box;
        }

        .host {
            width: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .host-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .client .host-icon { background-color: var(--client-color); }
        .server .host-icon { background-color: var(--server-color); }

        .timeline {
            width: 2px;
            height: 100%;
            background-color: #bdc3c7;
            position: relative;
        }

        .state-label {
            background: #ecf0f1;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .packet-area {
            flex-grow: 1;
            position: relative;
            margin: 0 20px;
        }

        .packet {
            position: absolute;
            background-color: var(--packet-color);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        /* ç®­å¤´çº¿æ¡ */
        .arrow-line {
            position: absolute;
            height: 2px;
            background-color: var(--packet-color);
            transform-origin: left center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 5;
        }
        .arrow-line::after {
            content: '';
            position: absolute;
            right: 0;
            top: -4px;
            border-left: 8px solid var(--packet-color);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        .log-panel {
            width: 800px;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #7f8c8d; font-size: 12px; margin-right: 10px; }
        .log-desc { color: #2c3e50; font-weight: bold; }
        .log-reason { 
            display: block; 
            margin-top: 4px; 
            color: #7f8c8d; 
            font-style: italic; 
            font-size: 13px; 
            padding-left: 20px;
            border-left: 3px solid #3498db;
        }

        /* åŠ¨ç”»ç±» */
        .animating {
            transition: all 1s linear;
        }
    </style>
</head>
<body>

    <h1>TCP åè®®å¯è§†åŒ–ï¼šä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹</h1>

    <div class="controls">
        <button id="btn-handshake" onclick="startHandshake()">å¼€å§‹ä¸‰æ¬¡æ¡æ‰‹</button>
        <button id="btn-wave" onclick="startWave()">å¼€å§‹å››æ¬¡æŒ¥æ‰‹</button>
        <button onclick="reset()">é‡ç½®</button>
    </div>

    <div class="diagram-container">
        <div class="host client">
            <div class="host-icon">C</div>
            <h3>Client</h3>
            <div class="timeline"></div>
            <div class="state-label" id="client-state">CLOSED</div>
        </div>

        <div class="packet-area" id="packet-area">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æ•°æ®åŒ…å°†åœ¨è¿™é‡Œ -->
        </div>

        <div class="host server">
            <div class="host-icon">S</div>
            <h3>Server</h3>
            <div class="timeline"></div>
            <div class="state-label" id="server-state">LISTEN</div>
        </div>
    </div>

    <div class="log-panel" id="log-panel">
        <h3>äº¤äº’æ—¥å¿—</h3>
        <div id="logs"></div>
    </div>

    <script>
        const clientStateEl = document.getElementById('client-state');
        const serverStateEl = document.getElementById('server-state');
        const packetArea = document.getElementById('packet-area');
        const logsEl = document.getElementById('logs');
        const btnHandshake = document.getElementById('btn-handshake');
        const btnWave = document.getElementById('btn-wave');

        let isAnimating = false;

        function log(message, reason) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            let html = `<span class="log-time">[${time}]</span><span class="log-desc">${message}</span>`;
            if (reason) {
                html += `<span class="log-reason">ğŸ’¡ è®¾è®¡ç›®çš„ï¼š${reason}</span>`;
            }
            div.innerHTML = html;
            logsEl.insertBefore(div, logsEl.firstChild);
        }

        function setClientState(state) {
            clientStateEl.textContent = state;
            clientStateEl.style.backgroundColor = '#f1c40f';
            setTimeout(() => clientStateEl.style.backgroundColor = '#ecf0f1', 500);
        }

        function setServerState(state) {
            serverStateEl.textContent = state;
            serverStateEl.style.backgroundColor = '#f1c40f';
            setTimeout(() => serverStateEl.style.backgroundColor = '#ecf0f1', 500);
        }

        // æ›´å¥½çš„åŠ¨ç”»å®ç°ï¼šä½¿ç”¨ç»å¯¹å®šä½å’Œè®¡ç®—
        function animatePacket(name, direction, startYPercent, endYPercent, onFinish) {
            const packet = document.createElement('div');
            packet.className = 'packet';
            packet.textContent = name;
            packetArea.appendChild(packet);

            const startX = direction === 'c2s' ? 0 : packetArea.offsetWidth;
            const endX = direction === 'c2s' ? packetArea.offsetWidth : 0;
            const startY = (packetArea.offsetHeight * startYPercent) / 100;
            const endY = (packetArea.offsetHeight * endYPercent) / 100;

            // ç»˜åˆ¶è¿çº¿
            const line = document.createElement('div');
            line.className = 'arrow-line';
            packetArea.appendChild(line);
            
            // è®¡ç®—è¿çº¿é•¿åº¦å’Œè§’åº¦
            const deltaX = endX - startX;
            const deltaY = endY - startY;
            const length = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;

            line.style.width = length + 'px';
            line.style.left = startX + 'px';
            line.style.top = startY + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            line.style.opacity = 1;

            // ç§»åŠ¨åŒ…
            packet.style.left = startX + 'px';
            packet.style.top = startY + 'px';
            packet.style.opacity = 1;
            
            // å¼ºåˆ¶é‡ç»˜
            packet.offsetHeight;

            packet.style.transition = 'left 1.5s linear, top 1.5s linear';
            packet.style.left = endX + 'px';
            packet.style.top = endY + 'px';

            setTimeout(() => {
                packet.style.opacity = 0;
                line.style.opacity = 0;
                setTimeout(() => {
                    packet.remove();
                    line.remove();
                }, 500);
                if (onFinish) onFinish();
            }, 1500);
        }

        async function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function startHandshake() {
            if (isAnimating) return;
            isAnimating = true;
            resetUI();
            btnHandshake.classList.add('active');
            
            log("å¼€å§‹ä¸‰æ¬¡æ¡æ‰‹...", "å»ºç«‹å¯é è¿æ¥ï¼Œç¡®è®¤åŒæ–¹çš„æ¥æ”¶å’Œå‘é€èƒ½åŠ›ã€‚");
            setClientState("CLOSED");
            setServerState("LISTEN");

            // Step 1: Client -> Server (SYN)
            await wait(500);
            setClientState("SYN_SENT");
            log("ç¬¬ä¸€æ¬¡æ¡æ‰‹: å®¢æˆ·ç«¯å‘é€ SYN=1, seq=x", "å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œå‘ŠçŸ¥åˆå§‹åºåˆ—å·ã€‚æ­¤æ—¶å®¢æˆ·ç«¯å¤„äº SYN_SENT çŠ¶æ€ã€‚");
            
            await new Promise(resolve => {
                animatePacket("SYN", "c2s", 10, 30, resolve);
            });

            setServerState("SYN_RCVD");
            log("æœåŠ¡ç«¯æ”¶åˆ° SYNï¼ŒçŠ¶æ€å˜ä¸º SYN_RCVD", "æœåŠ¡ç«¯ç¡®è®¤æ”¶åˆ°å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚");

            // Step 2: Server -> Client (SYN, ACK)
            await wait(500);
            log("ç¬¬äºŒæ¬¡æ¡æ‰‹: æœåŠ¡ç«¯å‘é€ SYN=1, ACK=1, seq=y, ack=x+1", "æœåŠ¡ç«¯åŒæ„è¿æ¥ (ACK)ï¼Œå¹¶å‘é€è‡ªå·±çš„åˆå§‹åºåˆ—å· (SYN)ã€‚é˜²æ­¢å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚çªç„¶åˆ°è¾¾å¯¼è‡´é”™è¯¯ã€‚");
            
            await new Promise(resolve => {
                animatePacket("SYN, ACK", "s2c", 30, 50, resolve);
            });

            setClientState("ESTABLISHED");
            log("å®¢æˆ·ç«¯æ”¶åˆ° SYN+ACKï¼ŒçŠ¶æ€å˜ä¸º ESTABLISHED", "å®¢æˆ·ç«¯ç¡®è®¤æœåŠ¡ç«¯æ”¶åˆ°äº†è‡ªå·±çš„ SYNï¼Œä¸”æœåŠ¡ç«¯æ„¿æ„å»ºç«‹è¿æ¥ã€‚å®¢æˆ·ç«¯è¿æ¥å»ºç«‹å®Œæˆã€‚");

            // Step 3: Client -> Server (ACK)
            await wait(500);
            log("ç¬¬ä¸‰æ¬¡æ¡æ‰‹: å®¢æˆ·ç«¯å‘é€ ACK=1, seq=x+1, ack=y+1", "å®¢æˆ·ç«¯ç¡®è®¤æ”¶åˆ°æœåŠ¡ç«¯çš„ SYNã€‚è‡³æ­¤ï¼ŒåŒæ–¹éƒ½ç¡®è®¤äº†å¯¹æ–¹çš„å‘é€å’Œæ¥æ”¶èƒ½åŠ›æ­£å¸¸ã€‚");
            
            await new Promise(resolve => {
                animatePacket("ACK", "c2s", 50, 70, resolve);
            });

            setServerState("ESTABLISHED");
            log("æœåŠ¡ç«¯æ”¶åˆ° ACKï¼ŒçŠ¶æ€å˜ä¸º ESTABLISHED", "æœåŠ¡ç«¯ç¡®è®¤å®¢æˆ·ç«¯æ”¶åˆ°äº†è‡ªå·±çš„ SYNã€‚æœåŠ¡ç«¯è¿æ¥å»ºç«‹å®Œæˆã€‚");
            log("ä¸‰æ¬¡æ¡æ‰‹å®Œæˆï¼Œè¿æ¥å»ºç«‹ï¼", "åŒæ–¹å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®ã€‚");
            
            isAnimating = false;
            btnHandshake.classList.remove('active');
        }

        async function startWave() {
            if (isAnimating) return;
            isAnimating = true;
            resetUI();
            btnWave.classList.add('active');

            // å‡è®¾åˆå§‹çŠ¶æ€æ˜¯ ESTABLISHED
            setClientState("ESTABLISHED");
            setServerState("ESTABLISHED");
            log("å¼€å§‹å››æ¬¡æŒ¥æ‰‹... (åˆå§‹çŠ¶æ€ ESTABLISHED)", "æ–­å¼€è¿æ¥ï¼Œé‡Šæ”¾èµ„æºã€‚TCP æ˜¯å…¨åŒå·¥çš„ï¼Œéœ€è¦åŒæ–¹åˆ†åˆ«å…³é—­ã€‚");

            // Step 1: Client -> Server (FIN)
            await wait(500);
            setClientState("FIN_WAIT_1");
            log("ç¬¬ä¸€æ¬¡æŒ¥æ‰‹: å®¢æˆ·ç«¯å‘é€ FIN=1, seq=u", "å®¢æˆ·ç«¯æ²¡æœ‰æ•°æ®è¦å‘é€äº†ï¼Œè¯·æ±‚å…³é—­è¿æ¥ã€‚è¿›å…¥åŠå…³é—­çŠ¶æ€ã€‚");

            await new Promise(resolve => {
                animatePacket("FIN", "c2s", 10, 30, resolve);
            });

            setServerState("CLOSE_WAIT");
            log("æœåŠ¡ç«¯æ”¶åˆ° FINï¼ŒçŠ¶æ€å˜ä¸º CLOSE_WAIT", "æœåŠ¡ç«¯æ”¶åˆ°å…³é—­è¯·æ±‚ï¼Œé€šçŸ¥åº”ç”¨å±‚å‡†å¤‡å…³é—­ã€‚ä½†æœåŠ¡ç«¯å¯èƒ½è¿˜æœ‰æ•°æ®æœªå‘é€å®Œã€‚");

            // Step 2: Server -> Client (ACK)
            // æœåŠ¡ç«¯å¯èƒ½è¿˜æœ‰æ•°æ®è¦å‘ï¼Œæ‰€ä»¥å…ˆå› ACK
            await wait(500);
            log("ç¬¬äºŒæ¬¡æŒ¥æ‰‹: æœåŠ¡ç«¯å‘é€ ACK=1, seq=v, ack=u+1", "æœåŠ¡ç«¯ç¡®è®¤æ”¶åˆ° FINï¼Œå‘ŠçŸ¥å®¢æˆ·ç«¯'æˆ‘çŸ¥é“ä½ æƒ³å…³äº†ï¼Œä½†æˆ‘å¯èƒ½è¿˜æœ‰æ•°æ®è¦å‘ï¼Œè¯·ç¨ç­‰'ã€‚");

            await new Promise(resolve => {
                animatePacket("ACK", "s2c", 30, 50, resolve);
            });

            setClientState("FIN_WAIT_2");
            log("å®¢æˆ·ç«¯æ”¶åˆ° ACKï¼ŒçŠ¶æ€å˜ä¸º FIN_WAIT_2", "å®¢æˆ·ç«¯ç­‰å¾…æœåŠ¡ç«¯å‘é€ FINã€‚æ­¤æ—¶å®¢æˆ·ç«¯ä»å¯æ¥æ”¶æ•°æ®ã€‚");

            // æ¨¡æ‹ŸæœåŠ¡ç«¯å¤„ç†å‰©ä½™æ•°æ®
            log("...æœåŠ¡ç«¯å¤„ç†å‰©ä½™æ•°æ®...", "æœåŠ¡ç«¯å‘é€å‰©ä½™æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚");
            await wait(1000);

            // Step 3: Server -> Client (FIN, ACK)
            setServerState("LAST_ACK");
            log("ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹: æœåŠ¡ç«¯æ•°æ®å‘é€å®Œæ¯•ï¼Œå‘é€ FIN=1, ACK=1, seq=w, ack=u+1", "æœåŠ¡ç«¯æ•°æ®å‘é€å®Œæ¯•ï¼Œæ­£å¼è¯·æ±‚å…³é—­è¿æ¥ã€‚");

            await new Promise(resolve => {
                animatePacket("FIN, ACK", "s2c", 50, 70, resolve);
            });

            setClientState("TIME_WAIT");
            log("å®¢æˆ·ç«¯æ”¶åˆ° FINï¼ŒçŠ¶æ€å˜ä¸º TIME_WAIT", "å®¢æˆ·ç«¯ç¡®è®¤æœåŠ¡ç«¯å·²å‡†å¤‡å¥½å…³é—­ã€‚");

            // Step 4: Client -> Server (ACK)
            await wait(500);
            log("ç¬¬å››æ¬¡æŒ¥æ‰‹: å®¢æˆ·ç«¯å‘é€ ACK=1, seq=u+1, ack=w+1", "å®¢æˆ·ç«¯ç¡®è®¤æ”¶åˆ°æœåŠ¡ç«¯çš„ FINã€‚");

            await new Promise(resolve => {
                animatePacket("ACK", "c2s", 70, 90, resolve);
            });

            setServerState("CLOSED");
            log("æœåŠ¡ç«¯æ”¶åˆ° ACKï¼ŒçŠ¶æ€å˜ä¸º CLOSED", "æœåŠ¡ç«¯è¿æ¥å½»åº•å…³é—­ã€‚");

            log("å®¢æˆ·ç«¯ç­‰å¾… 2MSL åå…³é—­...", "ç­‰å¾… 2MSL (æœ€é•¿æŠ¥æ–‡æ®µå¯¿å‘½) æ˜¯ä¸ºäº†ç¡®ä¿æœåŠ¡ç«¯æ”¶åˆ°äº†æœ€åçš„ ACKã€‚å¦‚æœæœåŠ¡ç«¯æ²¡æ”¶åˆ°ä¼šé‡ä¼  FINï¼Œå®¢æˆ·ç«¯å°±èƒ½é‡ä¼  ACKã€‚åŒæ—¶è®©ç½‘ç»œä¸­æ®‹å­˜æŠ¥æ–‡æ¶ˆå¤±ã€‚");
            await wait(1000); // æ¨¡æ‹Ÿç­‰å¾…
            setClientState("CLOSED");
            log("å®¢æˆ·ç«¯çŠ¶æ€å˜ä¸º CLOSEDã€‚å››æ¬¡æŒ¥æ‰‹å®Œæˆã€‚", "åŒæ–¹è¿æ¥å‡å·²å…³é—­ï¼Œèµ„æºé‡Šæ”¾ã€‚");

            isAnimating = false;
            btnWave.classList.remove('active');
        }

        function reset() {
            if (isAnimating) return;
            resetUI();
            log("å·²é‡ç½®");
        }

        function resetUI() {
            clientStateEl.textContent = "CLOSED";
            serverStateEl.textContent = "LISTEN";
            logsEl.innerHTML = '';
            packetArea.innerHTML = '';
            btnHandshake.classList.remove('active');
            btnWave.classList.remove('active');
        }
    </script>
</body>
</html>
